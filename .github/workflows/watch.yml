# .github/workflows/watch.yml

name: 'T&S Policy Watcher v1'

on:
  # This allows us to run the workflow manually from the Actions tab in GitHub.
  # Essential for testing and on-demand checks.
  workflow_dispatch:

  # This is the automated schedule. It uses a cron expression.
  # '0 */6 * * *' means "at minute 0, every 6th hour".
  # It will run at 00:00, 06:00, 12:00, 18:00 UTC.
  schedule:
    - cron: '0 */6 * * *'

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  watch-and-report:
    # We will run our job on the latest version of Ubuntu provided by GitHub.
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      # Step 1: Check out the repository code
      # This downloads our repository onto the runner so we can work with it.
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      # Step 2: Set up Python environment
      # We specify a version to ensure our script runs in a consistent environment.
      - name: 'Set up Python 3.11'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Step 3: Install dependencies and playwright
      - name: 'Install Dependencies'
        run: |
          pip install -r requirements.txt
          # The -E flag tells sudo to preserve the existing environment variables,
          # ensuring it uses the correct Python that setup-python configured.
          sudo -E $(which python) -m playwright install-deps
          python -m playwright install

      # Step 4: Run the fetcher script
      - name: 'Run Fetcher Script'
        run: python scripts/fetch.py

      # Step 5: Commit the new snapshots back to the repository
      - name: 'Commit Snapshots'
        id: commit
        run: |
          git config user.name "Policy Watch Bot"
          git config user.email "bot@github.com"
          git add snapshots/
          # If there are changes, commit them and output the SHA
          if ! git diff --staged --quiet; then
            git commit -m "CHORE: Update T&S policy snapshots"
            echo "commit_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          else
            echo "No changes to commit."
            echo "commit_sha=" >> "$GITHUB_OUTPUT"
          fi

      # Step 6: Pull latest changes to avoid race conditions
      # This ensures our local branch is up-to-date before pushing.
      - name: 'Pull Latest Changes'
        run: git pull origin main --rebase

      # Step 7: Push the changes back to the main branch
      # This uses a dedicated action to handle pushing the commits.
      - name: 'Push Changes'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main

      # Debug: Environment investigation for silent crash
      - name: 'DEBUG: Environment Investigation'
        run: |
          set -x
          echo "=== ENVIRONMENT DEBUG ==="
          echo "Current working directory:"
          pwd
          echo "---"
          echo "Python version and location:"
          which python
          python --version
          echo "---"
          echo "File system structure:"
          ls -laR
          echo "---"
          echo "Python import test:"
          python -c "import sys; print('Python can run'); print('Python path:', sys.path)"
          echo "---"
          echo "Check if diff_and_notify.py can be found:"
          if [ -f "scripts/diff_and_notify.py" ]; then
            echo "✓ scripts/diff_and_notify.py exists"
            ls -la scripts/diff_and_notify.py
          else
            echo "✗ scripts/diff_and_notify.py NOT FOUND"
          fi
          echo "=== END DEBUG ==="

      # Step 7: Test with minimal script first
      - name: 'Test Minimal Script'
        env:
          COMMIT_SHA: ${{ steps.commit.outputs.commit_sha }}
        run: |
          set -x
          echo "Testing minimal script first..."
          python scripts/diff_and_notify_minimal.py
          echo "Minimal script completed. Now testing full script..."

      # Step 8: Detect changes, generate summary, and set outputs
      - name: 'Detect Changes and Notify'
        id: diff
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          COMMIT_SHA: ${{ steps.commit.outputs.commit_sha }}
        run: |
          set -x
          echo "COMMIT_SHA value: '$COMMIT_SHA'"
          python scripts/diff_and_notify.py

      # --- PLACEHOLDER FOR NEXT STEPS ---
      # In our next iteration, we will add steps here to:
      # 1. Run the `create_github_issue.py` script if `failures.log` exists.
      # 2. Run the `diff_and_notify.py` script to analyze the commit we just made.